name: CodeQL Analysis Validator
description: Validates whether CodeQL analysis was performed on a given commit.

inputs:
  github_token:
    description: 'GitHub Token for API access'
    required: true
    default: ${{ secrets.GITHUB_TOKEN }}
  owner:
    description: 'Repository owner'
    required: false
    default: ${{ github.repository_owner }}
  repo:
    description: 'Repository name'
    required: false
    default: ${{ github.event.repository.name }}
  ref:
    description: 'Git reference (branch, tag, or commit SHA)'
    required: false
    default: ${{ github.sha }}
  tool_name:
    description: 'Code scanning tool name (e.g., CodeQL)'
    required: false
    default: CodeQL

runs:
  using: "composite"
  steps:
    - name: Validate CodeQL Analysis
      shell: bash
      run: |
        echo "Validating CodeQL analysis for commit: ${{ inputs.ref }} in repo ${{ inputs.owner }}/{{ inputs.repo }}"

        # Fetch the list of CodeQL analyses for the given commit
        response=$(curl -s -H "Authorization: token ${{ inputs.github_token }}" \
          "https://api.github.com/repos/${{ inputs.owner }}/${{ inputs.repo }}/code-scanning/analyses?ref=${{ inputs.ref }}&tool_name=${{ inputs.tool_name }}")

        analysis_count=$(echo "$response" | jq '. | length')
        if [ "$analysis_count" -eq 0 ]; then
          echo "❌ No CodeQL analysis found for ref: ${{ inputs.ref }}."
          exit 1
        fi

        echo "✅ CodeQL analysis found for ref: ${{ inputs.ref }}."
